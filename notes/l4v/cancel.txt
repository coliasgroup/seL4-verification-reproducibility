tools:

ccorres_gen_asm
ccorres_gen_asm2

ccorres_guard_imp{2}

?
ccorres_gen_asm{2}
ccorres_guard_imp{2}
hoare_post_imp
ccorres_symb_exec_r_known_rv_UNIV
hoare_strengthen_postE_R
ccorres_inst
hoare_vcg_conj_lift
ccorres_from_vcg

see in Finalise_C.thy:
    apply (rule_tac P="invs' and (\<lambda>s. sym_refs (state_refs_of' s)) and ko_at' ntfn ntfnptr" and P'=UNIV
             in ccorres_split_nothrow_novcg)

see in Delete_C.thy:
        apply (rule_tac A="λs. invs' s ∧ cte_wp_at' ((=) rv) slot' s
                                ∧ (expo ∨ ex_cte_cap_to' slot' s)
                                ∧ (final_matters' (cteCap rv) ⟶ rva = isFinal (cteCap rv) slot' (cteCaps_of s))"
                    and A'=UNIV
                     in ccorres_guard_imp2)

see in Finalise_C.thy:

    apply (rule_tac xf'=ret__unsigned_longlong_'
            and val="thread_state_to_tsType threadState"
            and R="st_tcb_at' ((=) threadState) thread"
            and R'=UNIV
            in
            ccorres_symb_exec_r_known_rv)

see in IpcCancel_C.thy:

      apply (rule_tac xf'=ret__int_'
                  and val="from_bool (scPtrOpt \<noteq> None)"
                  and R="\<lambda>s. obj_at' (\<lambda>tcb. tcbSchedContext tcb = scPtrOpt) tcbPtr s
                             \<and> valid_tcbs' s \<and> no_0_obj' s"
                  and R'=UNIV
                   in ccorres_symb_exec_r_known_rv)

   apply (rule_tac val="from_bool (\<exists>scPtr. scOpt = Some scPtr)"
               and xf'=ret__int_'
               and R="tcb_at' t and bound_sc_tcb_at' ((=) scOpt) t and valid_objs' and no_0_obj'"
               and R'=UNIV
                in ccorres_symb_exec_r_known_rv)

    apply (rule_tac P="tcb_at' thread" in ccorres_cross_over_guard)


investigate:
    ? ctcb_relation_blockingIPCCanGrantReplyD
    ! threadSet_ccorres_lemma{4,*}

    state_refs_of'_upd
    map_to_ko_at_updI'

    threadSet_pred_tcb_no_state

!!!
sym_ref_Receive_or_Reply_replyTCB'
sym_ref_Receive_or_Reply_replyTCB'

Reply_or_Receive_reply_at

      apply (rule_tac A="λs. sym_refs_asrt s" in ccorres_guard_imp2[where A'=UNIV])

      apply (rule_tac A="λs. bound ro ⟶ obj_at' (λr. replyTCB r = Some thread) (the ro) s" in ccorres_guard_imp2[where A'=UNIV])




see in IpcCancel_R.thy:

       \<comment>\<open>drop sym_refs assumtions; add reply_tcb link\<close>
      apply (rule_tac P="?abs_guard and (\<lambda>s. bound reply_opt \<longrightarrow> reply_tcb_reply_at ((=) (Some t)) (the reply_opt) s)
                         and valid_ep rv
                         and (\<lambda>_. (st = Structures_A.BlockedOnSend epPtr p
                                      \<longrightarrow> (\<exists>list. rv = Structures_A.SendEP list))
                                \<and> (st = Structures_A.thread_state.BlockedOnReceive epPtr reply_opt p'
                                     \<longrightarrow> (\<exists>list. rv = Structures_A.RecvEP list)))"
                  and P'="valid_objs' and st_tcb_at' ((=) st') t and valid_ep' ep
                          and pspace_aligned' and pspace_distinct'"
                   in corres_inst)
      \<comment>\<open>cross over replyTCB\<close>
      apply (rule_tac Q'="\<lambda>s. bound reply_opt \<longrightarrow> obj_at' (\<lambda>r. replyTCB r = Some t) (the reply_opt) s"
                      in corres_cross_add_guard)


NOTES:
- cthread_state_relation_lifted relates H and C thread state

-- -- --

apply (strengthen  invs_pspace_bounded')

see lemma replyUnlink_valid_objs'[wp]
see lemma sts_invs_minor'
see lemma map_to_scs_Some_scRefs_nonzero
    
see:
       apply (rule_tac Q'="λrv. invs' and cte_at' slot and valid_cap' cap" in hoare_strengthen_postE_R)
        apply (wp cteDelete_invs'')

see lemma cteDelete_invs''

apply (rule_tac Q'="λrv. invs' and tcb_at' thread and reply_at' foo and (λs. weak_sch_act_wf (ksSchedulerAction s) s)" in hoare_post_imp)


tools:

             apply (rule_tac P="..." in ccorres_cross_over_guard)

corres_inst?
ccorres_gen_asm{2}
ccorres_guard_imp{2}


hoare_pre
wp_pre
hoare_weaken_pre
ccorres_assume_pre



Testing for L4V_ARCH='RISCV64', L4V_FEATURES='MCS', L4V_PLAT='', INPUT_NUM_DOMAINS=''
Running 25 test(s)...
  Started isabelle ...              
  Started tests-xml-correct ...     
  Finished tests-xml-correct         passed      ( 0:00:00 real,  0:00:00 cpu,  0.01GB)
  Started kernel-config ...         
  Finished kernel-config             passed      ( 0:00:00 real,  0:00:00 cpu,  0.04GB)
  Started haskell-translator ...    
  Finished haskell-translator        passed      ( 0:00:00 real,  0:00:00 cpu,  0.04GB)
  Started HaskellKernel ...         
  Finished isabelle                  passed      ( 0:00:04 real,  0:00:10 cpu,  1.05GB)
  Started Docs ...                  
  Finished Docs                      passed      ( 0:00:08 real,  0:00:16 cpu,  1.83GB)
  Started Eisbach_Tools ...         
  Finished Eisbach_Tools             passed      ( 0:00:07 real,  0:00:18 cpu,  3.05GB)
  Started ML_Utils ...              
  Finished ML_Utils                  passed      ( 0:00:04 real,  0:00:12 cpu,  0.91GB)
  Started Monads ...                
  Finished Monads                    passed      ( 0:00:30 real,  0:01:54 cpu,  5.95GB)
  Started Lib ...                   
  Finished Lib                       passed      ( 0:00:04 real,  0:00:12 cpu,  1.06GB)
  Started EVTutorial ...            
  Finished EVTutorial                passed      ( 0:00:56 real,  0:03:53 cpu, 10.03GB)
  Started ASpec ...                 
  Finished ASpec                     passed      ( 0:00:05 real,  0:00:11 cpu,  1.05GB)
  Started AInvs ...                 
  Finished AInvs                     passed      ( 0:00:06 real,  0:00:12 cpu,  1.04GB)
  Started BaseRefine ...            
  Finished BaseRefine                passed      ( 0:00:06 real,  0:00:12 cpu,  1.04GB)
  Started Refine ...                
  Finished HaskellKernel             FAILED *    ( 0:02:37 real,  0:00:15 cpu,  0.43GB)
  Started ExecSpec ...              
  Finished ExecSpec                  passed      ( 0:02:32 real,  0:04:59 cpu, 11.27GB)
  Started CParser ...               
  Finished CParser                   passed      ( 0:00:06 real,  0:00:14 cpu,  1.04GB)
  Started CLib ...                  
  Finished CLib                      passed      ( 0:00:56 real,  0:04:05 cpu,  8.15GB)
  Started c-kernel ...              
  Finished c-kernel                  passed      ( 0:00:01 real,  0:00:00 cpu,  0.04GB)
  Started CKernel ...               
  Finished CKernel                   passed      ( 0:00:07 real,  0:00:14 cpu,  1.05GB)
  Started CSpec ...                 
  Finished CSpec                     passed      ( 0:00:07 real,  0:00:14 cpu,  1.02GB)
  Started CBaseRefine ...           
  Finished CBaseRefine               passed      ( 0:00:10 real,  0:00:19 cpu,  1.05GB)
  Started CRefine ...               
  Finished CRefine                   FAILED *    ( 0:52:13 real,  3:54:34 cpu, 24.91GB)
  Started CParserTest ...           
  Finished Refine                    passed      ( 0:58:28 real,  4:43:34 cpu, 25.86GB)
  Finished CParserTest               passed      ( 0:02:18 real,  0:11:08 cpu, 12.24GB)
  Started CParserTools ...          
  Finished CParserTools              FAILED *    ( 0:00:00 real,  0:00:00 cpu,  0.06GB)

------------------------------------------------------------------------
TEST FAILED: HaskellKernel

...
ghc-tinfo6-9.2.8:  202.98 MiB / 235.96 MiB ( 86.02%) downloaded...
ghc-tinfo6-9.2.8:  204.28 MiB / 235.96 MiB ( 86.57%) downloaded...
ghc-tinfo6-9.2.8:  206.26 MiB / 235.96 MiB ( 87.41%) downloaded...
ghc-tinfo6-9.2.8:  208.12 MiB / 235.96 MiB ( 88.20%) downloaded...
ghc-tinfo6-9.2.8:  209.86 MiB / 235.96 MiB ( 88.94%) downloaded...
ghc-tinfo6-9.2.8:  211.97 MiB / 235.96 MiB ( 89.83%) downloaded...
ghc-tinfo6-9.2.8:  213.69 MiB / 235.96 MiB ( 90.56%) downloaded...
ghc-tinfo6-9.2.8:  215.78 MiB / 235.96 MiB ( 91.45%) downloaded...
ghc-tinfo6-9.2.8:  217.53 MiB / 235.96 MiB ( 92.19%) downloaded...
ghc-tinfo6-9.2.8:  219.23 MiB / 235.96 MiB ( 92.91%) downloaded...
ghc-tinfo6-9.2.8:  221.59 MiB / 235.96 MiB ( 93.91%) downloaded...
ghc-tinfo6-9.2.8:  222.94 MiB / 235.96 MiB ( 94.48%) downloaded...
ghc-tinfo6-9.2.8:  224.53 MiB / 235.96 MiB ( 95.16%) downloaded...
ghc-tinfo6-9.2.8:  226.41 MiB / 235.96 MiB ( 95.95%) downloaded...
ghc-tinfo6-9.2.8:  228.81 MiB / 235.96 MiB ( 96.97%) downloaded...
ghc-tinfo6-9.2.8:  229.89 MiB / 235.96 MiB ( 97.43%) downloaded...
ghc-tinfo6-9.2.8:  231.36 MiB / 235.96 MiB ( 98.05%) downloaded...
ghc-tinfo6-9.2.8:  231.66 MiB / 235.96 MiB ( 98.17%) downloaded...
ghc-tinfo6-9.2.8:  233.05 MiB / 235.96 MiB ( 98.76%) downloaded...
ghc-tinfo6-9.2.8:  234.14 MiB / 235.96 MiB ( 99.23%) downloaded...
ghc-tinfo6-9.2.8:  235.94 MiB / 235.96 MiB ( 99.99%) downloaded...
ghc-tinfo6-9.2.8:  235.96 MiB / 235.96 MiB (100.00%) downloaded...
Downloaded ghc-tinfo6-9.2.8.
Unpacking GHC into /home/x/.stack/programs/x86_64-linux/ghc-tinfo6-9.2.8.temp/ ...
Configuring GHC ...
Installing GHC ...
Installed GHC.
[1 of 2] Compiling Main             ( /home/x/.stack/setup-exe-src/setup-CKvAmRb3.hs, /home/x/.stack/setup-exe-src/setup-CKvAmRb3.o )
[2 of 2] Compiling StackSetupShim   ( /home/x/.stack/setup-exe-src/setup-shim-CKvAmRb3.hs, /home/x/.stack/setup-exe-src/setup-shim-CKvAmRb3.o )
Linking /home/x/.stack/setup-exe-cache/x86_64-linux-tinfo6/tmp-Cabal-simple_CKvAmRb3_3.6.3.0_ghc-9.2.8 ...
/nix/store/d828ccvc2148g7m49hh3mzvyzwpipy46-binutils-2.42/bin/ld: cannot find -lgmp: No such file or directory
collect2: error: ld returned 1 exit status
`gcc' failed in phase `Linker'. (Exit code: 1)

Error: [S-6374]
       While building simple Setup.hs (scroll up to its section to see the error) using:
       /home/x/.stack/programs/x86_64-linux/ghc-tinfo6-9.2.8/bin/ghc-9.2.8 -rtsopts -threaded -clear-package-db -global-package-db -hide-all-packages -package base -main-is StackSetupShim.mainOverride -package Cabal-3.6.3.0 /home/x/.stack/setup-exe-src/setup-CKvAmRb3.hs /home/x/.stack/setup-exe-src/setup-shim-CKvAmRb3.hs -o /home/x/.stack/setup-exe-cache/x86_64-linux-tinfo6/tmp-Cabal-simple_CKvAmRb3_3.6.3.0_ghc-9.2.8
       Process exited with code: ExitFailure 1 
make: *** [Makefile:95: .stack-work] Error 1

------------------------------------------------------------------------
TEST FAILED: CRefine

...
***  6. ⋀s. ⟦badge = badge && mask 64; epptr = epptr && ~~ mask 4;
***          bos = ThreadState_BlockedOnSend ∧
***          epptr' = epptr ∧
***          badge' = badge ∧
***          cg = from_bool canGrant ∧
***          cgr = from_bool canGrantReply ∧ dc' = from_bool do_call;
***          (tcb_at' thread and valid_objs' and pspace_canonical' and
***           sch_act_not thread and
***           ep_at' epptr and
***           (λs. sch_act_wf (ksSchedulerAction s) s) and
***           no_0_obj' and
***           pspace_aligned' and
***           pspace_distinct')
***           s⟧
***         ⟹ (tcb_at' thread and tcb_at' thread and ?R8 and
***             (λ_. canonical_address epptr))
***             s
***  7. ⋀s. ⟦badge = badge && mask 64; epptr = epptr && ~~ mask 4;
***          bos = ThreadState_BlockedOnSend ∧
***          epptr' = epptr ∧
***          badge' = badge ∧
***          cg = from_bool canGrant ∧
***          cgr = from_bool canGrantReply ∧ dc' = from_bool do_call;
***          s ∈ UNIV⟧
***         ⟹ s ∈ UNIV
*** At command "apply" (line 4663 of "/work/l4v/proof/crefine/RISCV64/Ipc_C.thy")
*** Failed to finish proof:
*** goal (1 subgoal):
***  1. ⋀s s'.
***        ⟦(s, s') ∈ rf_sr; invs' s; sch_act_simple s;
***         weak_sch_act_wf (ksSchedulerAction s) s; tcb_at' thread s;
***         thread ≠ ksIdleThread s; sym_refs_asrt s⟧
***        ⟹ sym_refs (state_refs_of' s)
*** At command "done" (line 1541 of "/work/l4v/proof/crefine/RISCV64/Finalise_C.thy")
Unfinished session(s): CRefine

Finished at Wed Nov 27 22:52:32 GMT 2024
0:52:10 elapsed time, 3:52:56 cpu time, factor 4.46
make: *** [../misc/isa-common.mk:39: CRefine] Error 1

------------------------------------------------------------------------
TEST FAILED: CParserTools

make: *** No rule to make target '/work/l4v/tools/c-parser/standalone-parser/../../../isabelle/src/Pure/General/table.ML', needed by '/work/l4v/tools/c-parser/standalone-parser/table.ML'.  Stop.

------------------------------------------------------------------------


22/25 tests succeeded.

Tests failed.
